# GitLab CI n conjunction with GitLab Runner can use Docker Engine to test and build any application.
# Docker, when used with GitLab CI, runs each job in a separate and isolated container using the predefined image that is set up in .gitlab-ci.yml.
image: registry.gitlab.com/askapsdp/all_yandasoft:base

.common: {tags: [azure]}
# cache is used to specify a list of files and directories which should be cached between jobs. You can only use paths that are within the project workspace.

variables:
  YANDASOFT_BRANCH: develop
  DOCKER_REGISTRY_HOST: registry.gitlab.com
  DOCKER_REGISTRY_FOLDER: askapsdp
  DOCKER_HOST: tcp://docker:2375/

stages:
  - build_docker_image
  - deploy

.common_docker:
  image: docker:stable
  services:
    - docker:dind

#  before_script:
#    - docker login -u $DOCKER_REGISTRY_USERNAME -p $DOCKER_REGISTRY_PASSWORD $DOCKER_REGISTRY_HOST
#    - docker info

build_docker_image:
  stage: build_docker_image
  extends:
    - .common 
    - .common_docker
  script:
    # The docker image tag is:
    #  * The git tag if building a git tag
    #  * "latest" when building the develop branch
    #  * "stable" when building the master branch
    #  * The branch name
    - BRANCH=${CI_COMMIT_TAG:-${CI_COMMIT_BRANCH}}
    - DOCKER_TAG=$BRANCH
    - >
      if [ "$CI_COMMIT_BRANCH" = develop ]; then
        DOCKER_TAG=latest
      elif [ "$CI_COMMIT_BRANCH" = master ]; then
        DOCKER_TAG=stable
      fi
    - >
      docker build -t $DOCKER_REGISTRY_HOST/$DOCKER_REGISTRY_FOLDER/all_yandasoft:$DOCKER_TAG
      --build-arg BRANCH=${CI_COMMIT_BRANCH} -f .gitlab-docker .
    - docker save $DOCKER_REGISTRY_HOST/$DOCKER_REGISTRY_FOLDER/cbf_sdp_emulator:$DOCKER_TAG > docker_image.tar
  artifacts:
    paths:
      - docker_image.tar

publish_docker_image:
  stage: deploy
  extends: 
    - .common
    - .common_docker
  dependencies:
    - build_docker_image
  script:
    - image_id=`docker load < docker_image.tar | sed -n '/Loaded image:/ { s/Loaded image://p }'`
    - echo $image_id
    - docker push $image_id


